---
title: Traffic Data Analysis
output: html_document
---

```{r}
library(ggplot2)
library(dplyr)
library(reshape)
library(reshape2)
library(tidyr)
library(knitr)
```

# Data Processing : identify metrics and dimensions

##First of all importing the data into R

```{r}
by2olak_data = read.csv("all-semi-unique.csv")
str(lapply(by2olak_data, unique), vec.len = 4)
```
## Removal of all the columns related to advertisements

```{r}
by2olak_data = subset(by2olak_data, select=-c(ad.aid,ad.bgcl,ad.bgcls,ad.fncl,ad.fncls,ad.lid,ad.logo,
	ad.logo2x,ad.logoAndroidS,ad.logoAndroidH,ad.cm,ad.url,ad.g))
```

## Removal of columns with constant values
To get a quick idea of the data, a possible way is to get the number of unique values for each column
```{r}
rapply(by2olak_data,function(x)length(unique(x)))
```

### Unique values in rd.img column 
```{r}
unique(by2olak_data['rd.img'])
```
It is obvious that NA corresponds to no image which simply can be false.

```{r}
by2olak_data <- by2olak_data %>% mutate(rd.img = ifelse(is.na(rd.img),FALSE,rd.img))
```

### Unique values in rd.cl column 
```{r}
unique(by2olak_data['rd.cl'])
```
There is only one value so the column can be removed.
```{r}
by2olak_data <- subset( by2olak_data, select = -rd.cl)
```

### Unique values in rd.rp.type column
```{r}
unique(by2olak_data['rd.rp.type'])
```
Same thing like rd.cl, there is only one value which is zero so it can be removed.
```{r}
by2olak_data <- subset(by2olak_data, select = -rd.rp.type)
```

## Working with NAs

The Date is a little bit better than before
```{r, eval=F}
glimpse(by2olak_data)
```
The 2 columns rd.rp.fullnm & rd.rp.nm are similar from the values of the 2 columns as one is the username
 and the other is the full name of the user which is not very useful		

We can check the number of NAs in each of them
```{r}
sum(is.na(by2olak_data['rd.rp.fullnm']))
sum(is.na(by2olak_data['rd.rp.nm']))
```
It is possible to remove rd.rp.fullnm as it has a lot of NAs and the column does not provide any additional information
```{r}
by2olak_data <- subset( by2olak_data, select = -rd.rp.fullnm)
```
At this point, it is useful to see the number of NAs in each column:
```{r}
rapply(by2olak_data,function(x)sum(is.na(x)))
```
A lot of NAs are there in rd.rp.rpImg & rd.rp.img so we can add a default value for these NAs
```{r}
rapply(by2olak_data,function(x)sum(x == 0 | is.na(x)))
```
Since the number is the same for NAs and for NAs or zeros. We can conclude there are no zero values
 so it can be used as a default value
```{r}
by2olak_data <- by2olak_data %>% mutate(rd.rp.rpImg = ifelse(is.na(rd.rp.rpImg),0,rd.rp.rpImg))
by2olak_data <- by2olak_data %>% mutate(rd.rp.img = ifelse(is.na(rd.rp.img),0,rd.rp.img))
```

Let's see now the number of NAs in each column after cleaning the data.
```{r}
rapply(by2olak_data,function(x)sum(is.na(x)))
```
There are still Columns with NAs, the rd.rp.stid with NAs is actually comments or questioning info for the road.
A value should be given for such a scenario, let's have a look at the values of this column
```{r}
table(by2olak_data['rd.rp.stid'])
```
11 for example is a possible value to be used as they are all from 1 to 10.
```{r}
by2olak_data$rd.rp.stid[is.na(by2olak_data$rd.rp.stid)] <- 11
```

The NAs for the columns after adjustments
```{r}
rapply(by2olak_data,function(x)sum(is.na(x)))
```

For hours and mins of road rd.hr & rd.mn, their NAs can be removed as they are 1507 from all rows, which can be neglected.
```{r}	
by2olak_data <- by2olak_data[!is.na(by2olak_data$rd.hr),]
by2olak_data <- by2olak_data[!is.na(by2olak_data$rd.mn),]
```
Now the only column which contains NAs is rd.stid
```{r}
sum(is.na(by2olak_data['rd.stid']))
```
It can be omited as there are the last rows with NAs and they are around 6% of the whole data
```{r}
by2olak_data <- na.omit(by2olak_data)
```
Now all the columns have no NAs as a value 
```{r}
rapply(by2olak_data,function(x)sum(is.na(x)))
```

## Formatting the Crawl Date

To extract the day itself from data (Sun, Tue, etc.)
```{r}
by2olak_data$day <- gsub("([A-Za-z]+).*", "\\1", by2olak_data$crawl_date)
head(by2olak_data$day)
```
The  crawl_date is the date when this data was crawled in UTC which is 2 hours behind Cairo time), 
The crawl date will be adjusted to be synchronized with Cairo time (GMT+2)

In the R code it will be GMT-2 as the time was behind by 2 hours (-2)
```{r}
by2olak_data$crawl_date <- strptime(by2olak_data$crawl_date, format = "%a %b %d %X UTC %Y", tz = "UTC") %>% as.POSIXct()
by2olak_data$crawl_date <- format(by2olak_data$crawl_date , "%Y-%m-%d-%H-%M-%S", tz="Etc/GMT-2")
head(by2olak_data$crawl_date)
```

To modify the day to be Sunday, Tuesday instead of Sun,Tue, etc.
```{r}
by2olak_data <- by2olak_data %>% mutate(day = weekdays(as.Date(by2olak_data$crawl_date)))
head(by2olak_data$day)
```

Since the Crawl day is not necessarily the day of the report, calculation of the actual day should be done.
```{r}
by2olak_data <- by2olak_data %>% mutate(actual_day = 
	ifelse(by2olak_data$rd.hr < 24, weekdays(as.Date(by2olak_data$crawl_date)),
		ifelse(by2olak_data$rd.hr >= 24 & by2olak_data$rd.hr<= 48,weekdays(as.Date(by2olak_data$crawl_date)+1),
		weekdays(as.Date(by2olak_data$crawl_date)+2))))
head(by2olak_data[,c('day','actual_day','rd.hr')])
```

## Additional Columns for adding features

Create columns that split the road name into 2: 

First, Create a duplicate column which will be splited into 2 
```{r}
by2olak_data$rd.nm2 <- by2olak_data$rd.nm
```
Now split the column into 2 columns in which one is the road header and the other one is the path_taken
```{r, warning=FALSE}
by2olak_data <- by2olak_data %>% separate(rd.nm2, c("road.header", "road.path_taken"), ";")  
```

Now let's split the road.path_taken into 2 columns from and to columns
```{r}
by2olak_data <- by2olak_data %>% separate(road.path_taken, c("road.start", "road.destination"), " To ")  
```

Let's see the NAs in the new columns
```{r}
sum(is.na(by2olak_data['road.header']))
sum(is.na(by2olak_data['road.start']))
sum(is.na(by2olak_data['road.destination']))
```
There are NAs in road.start and road.destination as some roads have only header. Default values should replace the NAs.
```{r}
by2olak_data$road.start[is.na(by2olak_data$road.start)] <- "NONE"
by2olak_data$road.destination[is.na(by2olak_data$road.destination)] <- "NONE"
```


Create a column to show the reports origin : GPS or Users (boolean)
```{r}
by2olak_data['gps'] <- (by2olak_data['rd.rp.nm'] == "bey2ollakgps")
```

Create a column to show if the reports are from Annonnoumous Users.
```{r}
by2olak_data['anonymous'] <- (by2olak_data['rd.rp.nm'] == "fa3el kheir")
```

## Reordering columns
```{r}
colnames(by2olak_data)
```

The columns are not in order anymore, it can be fixed by specifying the order we want.
```{r}
by2olak_data <- subset(by2olak_data, select=c(day,actual_day,crawl_date,rd.nm,road.header,road.start,road.destination,rd.ri,
	rd.stid,rd.hr,rd.mn,rd.new,rd.img,rd.strq,rd.cmrq,rd.rp.nm,gps,anonymous,rd.rp.hr,
	rd.rp.mn,rd.rp.stid,rd.rp.cm,rd.rp.cmid,rd.rp.rpImg,rd.rp.img))
colnames(by2olak_data)
```

## Renaming the columns to give them a proper meaning
```{r}
by2olak_data <- rename(by2olak_data, c("rd.nm"="road_name", "rd.ri"="road_route_id","rd.stid"="road_status_id",
 "rd.hr"="road_update_hours_ago","rd.mn"="road_update_mins_ago", "rd.new"="road_new",
 "rd.img"="road_image","rd.strq"="road_status_request", "rd.cmrq"="road_comment_request",
 "rd.rp.nm"="report_username", "rd.rp.hr"="report_update_hours_ago", "rd.rp.mn"="report_update_mins_ago",
 "rd.rp.stid"="report_status_id" , "rd.rp.cm"="report_comment", "rd.rp.cmid"="report_comment_id" ,
 "rd.rp.rpImg"="report_roadimage" , "rd.rp.img"="report_username_image"))
colnames(by2olak_data)
```

# Descriptive Statistics to investigate the metrics and dimensions.

## Summary Statistics

## Data Visualization
```{r, message = FALSE}
data_plot <- melt(subset(by2olak_data, select=c(road_status_id,report_status_id,road_update_hours_ago,road_update_mins_ago,report_update_hours_ago,report_update_mins_ago)))
ggplot(data_plot,aes(x = value)) + 
    facet_wrap(~variable,scales = "free_x") + 
    geom_histogram()
```

```{r, message = FALSE}
ggplot(data=by2olak_data, aes(by2olak_data$road_status_id)) + geom_histogram()
ggplot(data=by2olak_data, aes(by2olak_data$report_status_id)) + geom_histogram()

qplot(as.factor(anonymous), data = by2olak_data)
qplot(as.factor(gps), data = by2olak_data)

qplot(road_route_id, road_status_id, data = by2olak_data, col=actual_day)

ggplot(data = melt(subset(by2olak_data, select=c(road_route_id))), aes(x=variable, y=value)) + geom_boxplot(aes(fill=variable))
ggplot(data = melt(subset(by2olak_data, select=c(road_status_id, report_status_id))), aes(x=variable, y=value)) + geom_boxplot(aes(fill=variable))
# ggplot(data = melt(subset(by2olak_data, select=-c(day, actual_day, crawl_date, road.header, road.start, road.destination, gps, anonymous,road_name,report_username, report_comment))), aes(x=variable, y=value)) + geom_boxplot(aes(fill=variable))

plot(table(by2olak_data['road_status_id']))
plot(table(by2olak_data['report_status_id']))

```

```{r, message = FALSE}
ggplot(by2olak_data[by2olak_data$road_status_id <= 5,] , aes(road_route_id, road_status_id, col = actual_day)) +
  geom_point(alpha = .6) +
  stat_smooth(se = FALSE, size = 1.5, span = .2) +
  scale_x_continuous("road route") +
  scale_y_continuous("road status") +
  scale_color_discrete("Day of Week")
```

```{r, message = FALSE}
ggplot(by2olak_data, aes(road_status_id, group=gps)) + 
    geom_histogram(aes(colour=gps, fill=gps), binwidth=1, alpha=0.9) +
    xlab("Roads Status") + ylab("Count") + ggtitle("Roads Status by bey2ollakgps")

ggplot(by2olak_data, aes(report_status_id, group=gps)) + 
    geom_histogram(aes(colour=gps, fill=gps), binwidth=1, alpha=0.9) +
    xlab("Reports Status") + ylab("Count") + ggtitle("Reports Status by bey2ollakgps")

ggplot(by2olak_data, aes(report_status_id, group=road_status_id)) + 
     geom_histogram(aes(colour=road_status_id, fill=road_status_id), binwidth=1, alpha=0.9) +
     xlab("Reports Status") + ylab("Count") + ggtitle("Reports Status by Road Status")
```

```{r, message = FALSE}
 data_plot <- subset(by2olak_data, select=c(actual_day,road_status_id,report_status_id,
road_update_hours_ago,road_update_mins_ago,report_update_hours_ago,report_update_mins_ago))

ggplot(filter(data_plot), aes(x= actual_day, y= road_update_hours_ago )) + 
     geom_boxplot(aes(fill = actual_day)) +
     stat_summary(fun.y=mean, geom="point", shape=23, size=4) + 
     ggtitle("hours since last update")
 ggplot(filter(data_plot), aes(x= actual_day, y= report_update_hours_ago )) + 
     geom_boxplot(aes(fill = actual_day)) +
     stat_summary(fun.y=mean, geom="point", shape=23, size=4) + 
     ggtitle("hours since last update")
```

## Commentary

# Inferential Data Analysis

## Parameter Inference (confidence intervals)

## Hypothesis Testing (null hypothesis testing)